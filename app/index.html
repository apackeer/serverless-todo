<!DOCTYPE html>

<html>
<title>
    AWS Recipes Demo - Ryan Green
</title>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>

    <script type="text/javascript" src="generated-js-sdk/lib/axios/dist/axios.standalone.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/CryptoJS/rollups/hmac-sha256.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/CryptoJS/rollups/sha256.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/CryptoJS/components/hmac.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/CryptoJS/components/enc-base64.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/moment/moment.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/url-template/url-template.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/apiGatewayCore/sigV4Client.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/apiGatewayCore/apiGatewayClient.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/apiGatewayCore/simpleHttpClient.js"></script>
    <script type="text/javascript" src="generated-js-sdk/lib/apiGatewayCore/utils.js"></script>

    <script type="text/javascript" src="generated-js-sdk/apigClient.js"></script>
</head>

<body>

<div class="main container">
    <h1>Recipes</h1>

    <div class="row">

        <div class="col-sm-8">

            <h2>All Recipes</h2>
            <pre id="response1">

                <i id="recipe-table-spinner" class="fa fa-refresh fa-spin fa-3x fa-fw margin-bottom"></i>

                <table id="recipe-table" class="table table-striped">
                    <thead>
                        <tr>
                        <th>Name</th>
                        <th>User</th>
                        <th>Instructions</th>
                        </tr>
                    </thead>
                </table>

            </pre>

        </div>

        <div class="col-sm-4">

            <h2>Add Recipe</h2>

            <form>
                <fieldset class="form-group">
                    <label for="recipe-name">Recipe Name</label>
                    <input id="recipe-name" type="text" placeholder="Recipe Name"/>
                </fieldset>
                <fieldset class="form-group">
                    <label for="recipe-instructions">Instructions</label>
                    <textarea id="recipe-instructions" rows="5" cols="50">...instructions</textarea>
                </fieldset>
                <fieldset class="form-group">
                    <input type="button" value="+ Add" class="btn btn-success" onclick="submitRecipe();" />
                    <span id="create-status"></span>
                </fieldset>
            </form>

        </div>

    </div>

</div>
</body>

<script type="text/javascript">

    AWS.config.region = 'us-east-1';
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: 'TODO: Add Cognito Identity Pool ID here!',
        RoleArn: 'TODO: Add Cognito role ARN here!'
    });

    var apigClient;

    AWS.config.credentials.get(function(){

        var identityId = AWS.config.credentials.identityId;
        var accessKeyId = AWS.config.credentials.accessKeyId;
        var secretAccessKey = AWS.config.credentials.secretAccessKey;
        var sessionToken = AWS.config.credentials.sessionToken;

        console.log("cognito identity id: " + identityId);
        console.log("cognito access key: " + accessKeyId);
        console.log("cognito secret key: " + secretAccessKey);
        console.log("cognito session token: " + sessionToken);

        apigClient = apigClientFactory.newClient({
            accessKey: accessKeyId,
            secretKey: secretAccessKey,
            sessionToken: sessionToken,
            region: 'us-east-1'
        });

        updateRecipes();
    });

    function updateRecipes() {
        apigClient.recipesGet({}, {}, {})
                .then(function(result) {
                    console.log(result);
                    var spinner = $('#recipe-table-spinner');
                    var table = $('#recipe-table');

                    table.empty();
                    spinner.hide();

                    $.each(result.data, function(index, value) {
                        var name = value.name;
                        var instructions = value.instructions;
                        var userId = value.userId;

                        var row = '<tr><td>' + name + '</td><td>' + userId + '</td><td>' + instructions + '</td></tr>';

                        table.append(row);
                    });

                }).catch( function(result) {
                    console.log(result);
                });
    }

    function submitRecipe() {
        $('#create-status').html('<i class="fa fa-refresh fa-spin fa-fw margin-bottom"></i>');

        var body = {
            name : $('#recipe-name').val(),
            instructions : $('#recipe-instructions').val()
        };

        apigClient.recipesPost({}, body, {})
                .then(function(result) {
                    console.log(result);

                    $('#create-status').html('<i class="fa fa-check"></i>');

                    updateRecipes();

                }).catch(function(result) {
                    console.error(result);
                    $('#create-status').html('<i class="fa fa-exclamation-circle"></i>' + result.data.errorMessage);
                });
    }
</script>